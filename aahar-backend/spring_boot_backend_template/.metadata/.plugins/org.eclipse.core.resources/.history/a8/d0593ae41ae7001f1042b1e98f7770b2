
package com.aahar.service;

import com.aahar.daos.MenuItemDao;
import com.aahar.daos.MessDao;
import com.aahar.daos.OrderDao;
import com.aahar.daos.OrderItemDao;
import com.aahar.daos.UserDao;
import com.aahar.dtos.PlaceOrderRequestDTO;
import com.aahar.pojos.*;
import com.aahar.repositories.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class OrderServiceImpl implements OrderService{

    @Autowired
    private UserDao userRepository;

    @Autowired
    private MessDao messRepository;

    @Autowired
    private MenuItemDao menuItemRepository;

    @Autowired
    private OrderDao orderRepository;

    @Autowired
    private OrderItemDao orderItemRepository;

    public String placeOrder(PlaceOrderRequestDTO request) {
        // Validate User
        User user = userRepository.findById(request.getUserId())
                .orElseThrow(() -> new IllegalArgumentException("Invalid user ID"));

        // Validate Mess
        Mess mess = messRepository.findById(request.getMessId())
                .orElseThrow(() -> new IllegalArgumentException("Invalid mess ID"));

        // Create Order
        Order order = new Order();
        order.setUser(user);
        order.setMess(mess);
        order.setOrderPlacedAt(LocalDateTime.now());
        order.setOrderStatus(Order.OrderStatus.PENDING);

        orderRepository.save(order);

        // Create Order Items
        List<OrderItem> orderItems = request.getItems().stream().map(item -> {
            MenuItem menuItem = menuItemRepository.findById(item.getMenuItemId())
                    .orElseThrow(() -> new IllegalArgumentException("Invalid menu item ID"));

            OrderItem orderItem = new OrderItem();
            orderItem.setOrder(order);
            orderItem.setMenuItem(menuItem);
            orderItem.setQuantity(item.getQuantity());

            return orderItem;
        }).collect(Collectors.toList());

        orderItemRepository.saveAll(orderItems);

        return "Order placed successfully with ID: " + order.getId();
    }
}
